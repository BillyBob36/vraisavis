generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// GESTION UTILISATEURS ET MULTI-TENANT
// ============================================

enum UserRole {
  SUPER_ADMIN
  VENDOR
  MANAGER
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum RestaurantStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum CommissionStatus {
  PENDING
  PAID
}

enum PrizeClaimStatus {
  PENDING
  CLAIMED
  EXPIRED
}

enum ContractType {
  CGU_CGV
  VENDOR_CONTRACT
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  REJECTED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          UserRole
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  managedRestaurants Restaurant[] @relation("RestaurantManager")
  
  @@map("users")
}

model Vendor {
  id               String   @id @default(cuid())
  email            String   @unique
  passwordHash     String
  name             String
  phone            String?
  referralCode     String   @unique
  commissionAmount Int      @default(5000)
  stripeAccountId  String?
  stripeOnboarded  Boolean  @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  restaurants      Restaurant[]
  commissions      Commission[]
  contracts        VendorContract[]
  
  @@map("vendors")
}

model Plan {
  id                   String   @id @default(cuid())
  name                 String
  priceMonthly         Int
  priceYearly          Int
  maxRestaurants       Int
  maxFeedbacksPerMonth Int?
  features             Json
  stripePriceIdMonthly String?
  stripePriceIdYearly  String?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  
  // Relations
  subscriptions Subscription[]
  
  @@map("plans")
}

model Restaurant {
  id              String           @id @default(cuid())
  name            String
  address         String
  latitude        Float
  longitude       Float
  geoRadius       Int              @default(100)
  phone           String?
  qrCodeUrl       String?
  status          RestaurantStatus @default(PENDING)
  
  serviceHours    Json
  
  welcomeMessage  String?
  thankYouMessage String?
  
  // Acceptation CGU/CGV
  cguAcceptedAt   DateTime?
  cguAcceptedIP   String?
  cguVersion      String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  managerId       String
  manager         User             @relation("RestaurantManager", fields: [managerId], references: [id])
  vendorId        String?
  vendor          Vendor?          @relation(fields: [vendorId], references: [id])
  subscription    Subscription?
  feedbacks       Feedback[]
  prizes          Prize[]
  prizeClaims     PrizeClaim[]
  fingerprints    Fingerprint[]
  dailyPrizePools DailyPrizePool[]
  
  @@map("restaurants")
}

model Subscription {
  id                   String             @id @default(cuid())
  status               SubscriptionStatus @default(TRIAL)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  trialEndsAt          DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  
  // Relations
  restaurantId         String             @unique
  restaurant           Restaurant         @relation(fields: [restaurantId], references: [id])
  planId               String
  plan                 Plan               @relation(fields: [planId], references: [id])
  payments             Payment[]
  
  @@map("subscriptions")
}

model Payment {
  id              String   @id @default(cuid())
  amount          Int
  currency        String   @default("eur")
  status          String
  stripePaymentId String?
  invoiceUrl      String?
  createdAt       DateTime @default(now())
  
  // Relations
  subscriptionId  String
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])
  
  @@map("payments")
}

model Commission {
  id               String           @id @default(cuid())
  amount           Int
  status           CommissionStatus @default(PENDING)
  triggeredAt      DateTime         @default(now())
  paidAt           DateTime?
  stripeTransferId String?
  
  // Relations
  vendorId     String
  vendor       Vendor @relation(fields: [vendorId], references: [id])
  restaurantId String
  
  @@map("commissions")
}

// ============================================
// FONCTIONNEL : FEEDBACKS ET JEU
// ============================================

model Feedback {
  id            String   @id @default(cuid())
  positiveText  String
  negativeText  String?
  serviceType   String
  isRead        Boolean  @default(false)
  isProcessed   Boolean  @default(false)
  createdAt     DateTime @default(now())
  
  // Relations
  restaurantId  String
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id])
  fingerprintId String
  fingerprint   Fingerprint  @relation(fields: [fingerprintId], references: [id])
  
  @@map("feedbacks")
}

model Fingerprint {
  id              String    @id @default(cuid())
  hash            String
  lastPlayedAt    DateTime?
  lastServiceType String?
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  
  // Relations
  restaurantId    String
  restaurant      Restaurant  @relation(fields: [restaurantId], references: [id])
  feedbacks       Feedback[]
  prizeClaims     PrizeClaim[]
  
  @@unique([hash, restaurantId])
  @@map("fingerprints")
}

model Prize {
  id           String   @id @default(cuid())
  name         String
  description  String?
  probability  Float
  isActive     Boolean  @default(true)
  maxPerDay    Int?
  maxPerWeek   Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  restaurantId String
  restaurant   Restaurant   @relation(fields: [restaurantId], references: [id])
  claims       PrizeClaim[]
  dailyPools   DailyPrizePool[]
  
  @@map("prizes")
}

model DailyPrizePool {
  id           String   @id @default(cuid())
  date         DateTime @db.Date
  allocated    Int
  claimed      Int      @default(0)
  
  // Relations
  prizeId      String
  prize        Prize      @relation(fields: [prizeId], references: [id])
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  
  @@unique([prizeId, date])
  @@map("daily_prize_pools")
}

model PrizeClaim {
  id            String           @id @default(cuid())
  code          String           @unique
  status        PrizeClaimStatus @default(PENDING)
  claimedAt     DateTime?
  expiresAt     DateTime
  createdAt     DateTime         @default(now())
  
  // Relations
  prizeId       String
  prize         Prize        @relation(fields: [prizeId], references: [id])
  restaurantId  String
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id])
  fingerprintId String
  fingerprint   Fingerprint  @relation(fields: [fingerprintId], references: [id])
  
  @@map("prize_claims")
}

// ============================================
// GESTION DES CONTRATS
// ============================================

model ContractTemplate {
  id                String   @id @default(cuid())
  type              ContractType
  version           String   @default("1.0")
  
  // Informations légales société
  companyName       String
  companyLegalForm  String
  companyCapital    String
  companyAddress    String
  companyRCS        String
  companySIRET      String
  companyVAT        String
  companyPhone      String
  companyEmail      String
  companyDirector   String
  
  // Hébergeur
  hostingProvider   String
  hostingAddress    String
  
  // DPO
  dpoEmail          String?
  
  // Médiateur
  mediatorName      String
  mediatorAddress   String
  mediatorWebsite   String
  
  // Juridiction
  jurisdiction      String
  
  // Tarifs (pour CGU)
  monthlyPrice      Int?
  
  // Commission (pour contrat vendeur)
  commissionRate    Float?
  commissionDuration Int?
  
  // Contenu du contrat
  contractContent   String   @db.Text
  
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  vendorContracts   VendorContract[]
  
  @@map("contract_templates")
}

model VendorContract {
  id                String         @id @default(cuid())
  status            ContractStatus @default(DRAFT)
  
  // Signature électronique
  signedAt          DateTime?
  signatureIP       String?
  signatureData     String?        @db.Text
  
  // Informations vendeur au moment de la signature
  vendorName        String
  vendorEmail       String
  vendorAddress     String?
  vendorSIRET       String?
  vendorIBAN        String?
  
  // Suivi
  sentAt            DateTime?
  viewedAt          DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  vendorId          String
  vendor            Vendor         @relation(fields: [vendorId], references: [id])
  templateId        String
  template          ContractTemplate @relation(fields: [templateId], references: [id])
  
  @@map("vendor_contracts")
}
